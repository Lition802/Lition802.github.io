<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="写完第一版的程序之后我发现按下按钮只能触发一次，按下之后电平就被拉低了，一直为LOW。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>ESP8266使用旋转编码器（二） | Lition的博客</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 7.0.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">主页</a><a class="sidebar-nav-item" href="/archives">归档</a><a class="sidebar-nav-item" href="/about">关于</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/ESP8266/" rel="tag">ESP8266</a></div><div class="post-time">2024-02-03</div></div></div><div class="container post-header"><h1>ESP8266使用旋转编码器（二）</h1></div><div class="container post-content"><p>写完第一版的程序之后我发现按下按钮只能触发一次，按下之后电平就被拉低了，一直为LOW。</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pFQvOUJ"><img src="https://s11.ax1x.com/2024/02/03/pFQvOUJ.md.png" alt="pFQvOUJ.md.png"></a></p>
<p>按照上面的方法接入一个电阻之后，电平为LOW的时候用3v电压把电平拉回来。</p>
<p>同时我还接入了OLED显示屏显示旋转的值。</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pFQvvCR"><img src="https://s11.ax1x.com/2024/02/03/pFQvvCR.md.jpg" alt="pFQvvCR.md.jpg"></a></p>
<table>
<thead>
<tr>
<th align="center">开发板引脚</th>
<th align="center">元件引脚</th>
</tr>
</thead>
<tbody><tr>
<td align="center">D0</td>
<td align="center">编码器SW</td>
</tr>
<tr>
<td align="center">D0</td>
<td align="center">下拉电阻</td>
</tr>
<tr>
<td align="center">D1</td>
<td align="center">屏幕SCL</td>
</tr>
<tr>
<td align="center">D2</td>
<td align="center">屏幕SDA</td>
</tr>
<tr>
<td align="center">D5</td>
<td align="center">编码器CLK</td>
</tr>
<tr>
<td align="center">D6</td>
<td align="center">编码器DT</td>
</tr>
</tbody></table>
<p>这里把D3和D4空出来因为下拉这两个引脚会导致无法上传程序</p>
<div class="highlight-wrap"autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"data-rel="C"><figure class="iseeu highlight /c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Rotary Encoder Inputs</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLK D5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT D6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SW D0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Adafruit_GFX.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Adafruit_SSD1306.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCREEN_WIDTH 128  <span class="comment">// OLED display width, in pixels</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCREEN_HEIGHT 32  <span class="comment">// OLED display height, in pixels</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &amp;Wire, OLED_RESET);</span></span><br><span class="line">Adafruit_SSD1306 <span class="title function_">display</span><span class="params">(<span class="number">128</span>, <span class="number">64</span>, &amp;Wire, <span class="number">-1</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> counter = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> currentStateCLK;</span><br><span class="line"><span class="type">int</span> lastStateCLK;</span><br><span class="line">String currentDir = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> lastButtonPress = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ShowText</span><span class="params">(String text)</span> &#123;</span><br><span class="line">  display.clearDisplay();</span><br><span class="line">  display.setTextSize(<span class="number">1</span>);  <span class="comment">// Draw 2X-scale text 2倍字体</span></span><br><span class="line">  display.setTextColor(SSD1306_WHITE);</span><br><span class="line">  display.setCursor(<span class="number">1</span>, <span class="number">1</span>);  <span class="comment">//显示的坐标位置</span></span><br><span class="line">  display.println(text);</span><br><span class="line">  display.display();  <span class="comment">// Show text</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ShowNum</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">  display.clearDisplay();</span><br><span class="line">  display.setTextSize(<span class="number">2</span>);  <span class="comment">// Draw 2X-scale text 2倍字体</span></span><br><span class="line">  display.setTextColor(SSD1306_WHITE);</span><br><span class="line">  display.setCursor(<span class="number">10</span>, <span class="number">10</span>);  <span class="comment">//显示的坐标位置</span></span><br><span class="line">  display.println(num);</span><br><span class="line">  display.display();  <span class="comment">// Show text</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set encoder pins as inputs</span></span><br><span class="line">  pinMode(CLK, INPUT);</span><br><span class="line">  pinMode(DT, INPUT);</span><br><span class="line">  pinMode(SW, INPUT_PULLUP);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup Serial Monitor</span></span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read the initial state of CLK</span></span><br><span class="line">  lastStateCLK = digitalRead(CLK);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// SSD1306_SWITCHCAPVCC = generate display voltage from 3.3V internally</span></span><br><span class="line">  <span class="keyword">if</span> (!display.begin(SSD1306_SWITCHCAPVCC, <span class="number">0x3C</span>)) &#123;  <span class="comment">// Address 0x3C for 128x32</span></span><br><span class="line">    Serial.println(F(<span class="string">&quot;SSD1306 allocation failed&quot;</span>));</span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">      ;  <span class="comment">// Don&#x27;t proceed, loop forever</span></span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;boot up complete&quot;</span>);</span><br><span class="line">  <span class="comment">// 清空显示</span></span><br><span class="line">  ShowText(<span class="string">&quot;standby....&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read the current state of CLK</span></span><br><span class="line">  currentStateCLK = digitalRead(CLK);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If last and current state of CLK are different, then pulse occurred</span></span><br><span class="line">  <span class="comment">// React to only 1 state change to avoid double count</span></span><br><span class="line">  <span class="keyword">if</span> (currentStateCLK != lastStateCLK &amp;&amp; currentStateCLK == <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the DT state is different than the CLK state then</span></span><br><span class="line">    <span class="comment">// the encoder is rotating CCW so decrement</span></span><br><span class="line">    <span class="keyword">if</span> (digitalRead(DT) != currentStateCLK) &#123;</span><br><span class="line">      counter--;</span><br><span class="line">      currentDir = <span class="string">&quot;CCW&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Encoder is rotating CW so increment</span></span><br><span class="line">      counter++;</span><br><span class="line">      currentDir = <span class="string">&quot;CW&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Serial.print(<span class="string">&quot;Direction: &quot;</span>);</span><br><span class="line">    Serial.print(currentDir);</span><br><span class="line">    Serial.print(<span class="string">&quot; | Counter: &quot;</span>);</span><br><span class="line">    Serial.println(counter);</span><br><span class="line">    ShowNum(counter);</span><br><span class="line">    <span class="comment">// 清空显示</span></span><br><span class="line">    <span class="comment">// display.clearDisplay();</span></span><br><span class="line">    <span class="comment">// // 使更改的显示生效</span></span><br><span class="line">    display.display();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remember last CLK state</span></span><br><span class="line">  lastStateCLK = currentStateCLK;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read the button state</span></span><br><span class="line">  <span class="type">int</span> btnState = digitalRead(SW);</span><br><span class="line">  <span class="comment">// Serial.println(btnState);</span></span><br><span class="line">  <span class="comment">//If we detect LOW signal, button is pressed</span></span><br><span class="line">  <span class="keyword">if</span> (btnState == LOW) &#123;</span><br><span class="line">    <span class="comment">//if 50ms have passed since last LOW pulse, it means that the</span></span><br><span class="line">    <span class="comment">//button has been pressed, released and pressed again</span></span><br><span class="line">    <span class="keyword">if</span> (millis() - lastButtonPress &gt; <span class="number">50</span>) &#123;</span><br><span class="line">      Serial.println(<span class="string">&quot;Button pressed!&quot;</span>);</span><br><span class="line">      counter = <span class="number">0</span>;</span><br><span class="line">      ShowNum(counter);</span><br><span class="line">      display.display();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remember last button press event</span></span><br><span class="line">    lastButtonPress = millis();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Put in a slight delay to help debounce the reading</span></span><br><span class="line">  delay(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/lato-font/3.0.0/css/lato-font.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcdn.net/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>